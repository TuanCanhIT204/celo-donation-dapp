<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Celo Donation Platform – Minimal DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:#0b1220;color:#e6edf3;margin:0}
    header{padding:18px 20px;border-bottom:1px solid #1f2a44;background:#0d1528;position:sticky;top:0}
    main{max-width:980px;margin:0 auto;padding:24px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:#0f1830;border:1px solid #203055;border-radius:14px;padding:16px;box-shadow:0 0 0 1px #0a1224 inset}
    .card h3{margin:0 0 10px}
    input,textarea,button,select{width:100%;box-sizing:border-box;border-radius:10px;padding:10px;border:1px solid #2a3b66;background:#0c1430;color:#e6edf3}
    input:focus,textarea:focus,select:focus{outline:2px solid #3b82f6}
    label{font-size:13px;opacity:.9;margin-bottom:6px;display:block}
    button{cursor:pointer;background:#2563eb;border-color:#1e40af}
    button:hover{background:#1d4ed8}
    small.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;opacity:.8}
    .grid{display:grid;gap:10px}
    .muted{opacity:.8}
    .ok{color:#22c55e}
    .warn{color:#f59e0b}
    .err{color:#ef4444}
    .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0a1736;border:1px solid #233863}
    .mono{font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .cols3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:900px){.row,.cols3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="row" style="grid-template-columns:auto auto;align-items:center">
      <div>
        <strong>Celo Donation Platform</strong>
        <span class="pill" id="netPill">Network: <span id="netName">—</span></span>
      </div>
      <div class="right">
        <input id="contractAddress" placeholder="Contract address (e.g. 0xabc...)" style="min-width:360px" />
        <button id="setContractBtn">Use Contract</button>
        <button id="connectBtn">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main>
    <div class="row">
      <div class="card">
        <h3>Status</h3>
        <div class="grid">
          <div>Account: <span id="acct" class="mono muted">—</span></div>
          <div>Balance: <span id="bal" class="mono muted">—</span></div>
          <div>Contract: <span id="addrShow" class="mono muted">—</span></div>
          <div>Campaigns: <span id="count" class="mono muted">—</span></div>
          <div>Message: <span id="msg" class="muted">Ready</span></div>
        </div>
      </div>

      <div class="card">
        <h3>Quick Read – Campaign</h3>
        <div class="grid">
          <label>Campaign ID <input id="readId" type="number" min="1" value="1" /></label>
          <button id="readBtn">Read campaign</button>
          <div id="readOut" class="mono muted"></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h3>Create Campaign</h3>
        <div class="grid">
          <label>Beneficiary (address) <input id="cc_beneficiary" placeholder="0x..." /></label>
          <label>Title <input id="cc_title" placeholder="Aid for School Library" /></label>
          <label>Description <textarea id="cc_desc" rows="3" placeholder="Fund books & chairs for village school"></textarea></label>
          <label>Goal (CELO) <input id="cc_goal" type="number" step="0.0001" placeholder="5" /></label>
          <button id="createBtn">Create</button>
          <small class="mono muted">Note: goal will be converted to wei via parseEther()</small>
        </div>
      </div>

      <div class="card">
        <h3>Donate</h3>
        <div class="grid">
          <label>Campaign ID <input id="don_id" type="number" min="1" value="1" /></label>
          <label>Amount (CELO) <input id="don_amount" type="number" step="0.0001" placeholder="0.2" /></label>
          <button id="donateBtn">Donate</button>
          <small class="mono muted">Value is sent with the transaction (ethers.parseEther).</small>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h3>Withdraw (Beneficiary only)</h3>
        <div class="grid">
          <label>Campaign ID <input id="wd_id" type="number" min="1" value="1" /></label>
          <label>Amount (CELO) <input id="wd_amount" type="number" step="0.0001" placeholder="0.5" /></label>
          <button id="withdrawBtn">Withdraw</button>
        </div>
      </div>

      <div class="card">
        <h3>Close Campaign (Creator only)</h3>
        <div class="grid">
          <label>Campaign ID <input id="cl_id" type="number" min="1" value="1" /></label>
          <button id="closeBtn">Close</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Transparency – Donors</h3>
      <div class="grid cols3">
        <label>Campaign ID <input id="donors_id" type="number" min="1" value="1" /></label>
        <button id="donorsBtn">Load Donors</button>
        <div></div>
      </div>
      <div id="donorList" class="grid" style="margin-top:10px"></div>
    </div>

    <p class="muted" style="margin-top:20px">Tip: Switch MetaMask to <span class="mono">Celo Sepolia Testnet</span>. If counts don’t refresh, click “Use Contract” again.</p>
  </main>

<script>
// ===== ABI (from DonationPlatform.sol) =====
const ABI = [
  {"type":"function","name":"campaignCount","inputs":[],"outputs":[{"name":"","type":"uint256"}],"stateMutability":"view"},
  {"type":"function","name":"campaigns","inputs":[{"name":"","type":"uint256"}],"outputs":[
    {"name":"creator","type":"address"},
    {"name":"beneficiary","type":"address"},
    {"name":"title","type":"string"},
    {"name":"description","type":"string"},
    {"name":"goal","type":"uint256"},
    {"name":"raised","type":"uint256"},
    {"name":"active","type":"bool"}
  ],"stateMutability":"view"},
  {"type":"function","name":"createCampaign","inputs":[
    {"name":"_beneficiary","type":"address"},
    {"name":"_title","type":"string"},
    {"name":"_description","type":"string"},
    {"name":"_goal","type":"uint256"}
  ],"outputs":[{"name":"id","type":"uint256"}],"stateMutability":"nonpayable"},
  {"type":"function","name":"donate","inputs":[{"name":"id","type":"uint256"}],"outputs":[],"stateMutability":"payable"},
  {"type":"function","name":"withdraw","inputs":[{"name":"id","type":"uint256"},{"name":"amount","type":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},
  {"type":"function","name":"closeCampaign","inputs":[{"name":"id","type":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},
  {"type":"function","name":"getDonors","inputs":[{"name":"id","type":"uint256"}],"outputs":[{"name":"","type":"address[]"}],"stateMutability":"view"},
  {"type":"function","name":"donatedOf","inputs":[{"name":"id","type":"uint256"},{"name":"donor","type":"address"}],"outputs":[{"name":"","type":"uint256"}],"stateMutability":"view"},
  {"type":"event","name":"CampaignCreated","inputs":[
    {"indexed":true,"name":"id","type":"uint256"},
    {"indexed":true,"name":"creator","type":"address"},
    {"indexed":true,"name":"beneficiary","type":"address"},
    {"indexed":false,"name":"title","type":"string"},
    {"indexed":false,"name":"goal","type":"uint256"}
  ]},
  {"type":"event","name":"DonationReceived","inputs":[
    {"indexed":true,"name":"id","type":"uint256"},
    {"indexed":true,"name":"donor","type":"address"},
    {"indexed":false,"name":"amount","type":"uint256"},
    {"indexed":false,"name":"newRaised","type":"uint256"}
  ]},
  {"type":"event","name":"Withdrawal","inputs":[
    {"indexed":true,"name":"id","type":"uint256"},
    {"indexed":true,"name":"beneficiary","type":"address"},
    {"indexed":false,"name":"amount","type":"uint256"}
  ]},
  {"type":"event","name":"CampaignClosed","inputs":[
    {"indexed":true,"name":"id","type":"uint256"}
  ]}
];

let provider, signer, contract;

function setMsg(t, cls=""){
  const el = document.getElementById('msg');
  el.textContent = t;
  el.className = cls ? cls : 'muted';
}

async function connect(){
  if(!window.ethereum){ setMsg('No wallet found. Install MetaMask.', 'err'); return; }
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send('eth_requestAccounts', []);
  signer = await provider.getSigner();
  const addr = await signer.getAddress();
  document.getElementById('acct').textContent = addr;
  const bal = await provider.getBalance(addr);
  document.getElementById('bal').textContent = `${ethers.formatEther(bal)} CELO`;
  const net = await provider.getNetwork();
  document.getElementById('netName').textContent = `${net.name || 'Custom'} (${Number(net.chainId)})`;
  setMsg('Wallet connected ✅','ok');
}

function getAddr(){
  return document.getElementById('contractAddress').value.trim();
}

async function useContract(){
  if(!signer){ await connect(); }
  const address = getAddr();
  if(!address){ setMsg('Enter contract address first.','warn'); return; }
  contract = new ethers.Contract(address, ABI, signer);
  document.getElementById('addrShow').textContent = address;
  try{
    const cnt = await contract.campaignCount();
    document.getElementById('count').textContent = cnt.toString();
    setMsg('Contract set ✔️','ok');
  }catch(e){
    console.error(e);
    setMsg('Cannot read from contract. Wrong address or network?','err');
  }
}

async function readCampaign(){
  if(!contract){ return setMsg('Set contract first.','warn'); }
  const id = Number(document.getElementById('readId').value||'0');
  if(!id) return setMsg('Enter campaign id.','warn');
  const c = await contract.campaigns(id);
  const out = `creator:   ${c.creator}\nbenefici.: ${c.beneficiary}\n`+
              `title:     ${c.title}\n`+
              `goal:      ${ethers.formatEther(c.goal)} CELO\n`+
              `raised:    ${ethers.formatEther(c.raised)} CELO\n`+
              `active:    ${c.active}`;
  document.getElementById('readOut').textContent = out;
}

async function createCampaign(){
  if(!contract){ return setMsg('Set contract first.','warn'); }
  const b = document.getElementById('cc_beneficiary').value.trim();
  const t = document.getElementById('cc_title').value.trim();
  const d = document.getElementById('cc_desc').value.trim();
  const g = document.getElementById('cc_goal').value.trim();
  if(!b || !t || !d || !g) return setMsg('Fill all fields.','warn');
  const goalWei = ethers.parseEther(g);
  const tx = await contract.createCampaign(b, t, d, goalWei);
  setMsg('Creating campaign…');
  const rc = await tx.wait();
  // try to parse id from event
  let idTxt = '(unknown)';
  for(const log of rc.logs){
    try{
      const ev = contract.interface.parseLog(log);
      if(ev && ev.name === 'CampaignCreated'){
        idTxt = ev.args.id?.toString?.() || ev.args[0]?.toString?.() || idTxt;
      }
    }catch(_){/* ignore */}
  }
  const cnt = await contract.campaignCount();
  document.getElementById('count').textContent = cnt.toString();
  setMsg(`Campaign created: id ${idTxt} ✅`, 'ok');
}

async function donate(){
  if(!contract){ return setMsg('Set contract first.','warn'); }
  const id = Number(document.getElementById('don_id').value||'0');
  const amt = document.getElementById('don_amount').value.trim();
  if(!id || !amt) return setMsg('Enter id and amount.','warn');
  const value = ethers.parseEther(amt);
  const tx = await contract.donate(id, { value });
  setMsg('Donating…');
  await tx.wait();
  setMsg('Donation confirmed ✅', 'ok');
}

async function withdraw(){
  if(!contract){ return setMsg('Set contract first.','warn'); }
  const id = Number(document.getElementById('wd_id').value||'0');
  const amt = document.getElementById('wd_amount').value.trim();
  if(!id || !amt) return setMsg('Enter id and amount.','warn');
  const amount = ethers.parseEther(amt);
  const tx = await contract.withdraw(id, amount);
  setMsg('Withdrawing…');
  await tx.wait();
  setMsg('Withdraw confirmed ✅','ok');
}

async function closeCampaign(){
  if(!contract){ return setMsg('Set contract first.','warn'); }
  const id = Number(document.getElementById('cl_id').value||'0');
  if(!id) return setMsg('Enter campaign id.','warn');
  const tx = await contract.closeCampaign(id);
  setMsg('Closing…');
  await tx.wait();
  setMsg('Campaign closed ✅','ok');
}

async function loadDonors(){
  if(!contract){ return setMsg('Set contract first.','warn'); }
  const id = Number(document.getElementById('donors_id').value||'0');
  if(!id) return setMsg('Enter campaign id.','warn');
  const list = await contract.getDonors(id);
  const box = document.getElementById('donorList');
  box.innerHTML = '';
  if(!list || list.length===0){ box.innerHTML = '<div class="muted">No donors yet.</div>'; return; }
  list.forEach(async (addr)=>{
    let amtWei = 0n;
    try{ amtWei = await contract.donatedOf(id, addr); }catch(_){ }
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML = `<div class="mono">${addr}</div><div class="muted">Donated: ${ethers.formatEther(amtWei)} CELO</div>`;
    box.appendChild(div);
  });
}

// Wiring
 document.getElementById('connectBtn').onclick = connect;
 document.getElementById('setContractBtn').onclick = useContract;
 document.getElementById('readBtn').onclick = readCampaign;
 document.getElementById('createBtn').onclick = createCampaign;
 document.getElementById('donateBtn').onclick = donate;
 document.getElementById('withdrawBtn').onclick = withdraw;
 document.getElementById('closeBtn').onclick = closeCampaign;
 document.getElementById('donorsBtn').onclick = loadDonors;
</script>
</body>
</html>
